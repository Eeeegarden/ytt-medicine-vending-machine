<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>STOMP WebSocket Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<h1>STOMP WebSocket Test</h1>
<button onclick="connect()">Connect</button>

<h2>Complete Order</h2>
<label for="completeOrderId">Order ID:</label>
<input type="text" id="completeOrderId" placeholder="Enter Order ID to Complete" />
<button onclick="completeOrder()">Complete Order</button>

<h2>Cancel Order</h2>
<label for="cancelOrderId">Order ID:</label>
<input type="text" id="cancelOrderId" placeholder="Enter Order ID to Cancel" />
<button onclick="cancelOrder()">Cancel Order</button>

<h2>Current Orders</h2>
<h3>Pending Orders</h3>
<div id="pendingOrders"></div>

<h3>Completed Orders</h3>
<div id="completedOrders"></div>

<h3>Canceled Orders</h3>
<div id="canceledOrders"></div>

<div id="messages"></div>

<script>
    var stompClient = null;

    function connect() {
        var socket = new SockJS('/ws'); // 상대 경로 사용
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function(frame) {
            console.log('Connected: ' + frame);
            stompClient.subscribe('/topic/order/complete', function(response) { // 주문 완료 구독
                showMessage("Order Completed: " + JSON.parse(response.body).id);
                fetchCurrentOrders(); // 현재 주문 내역을 다시 가져오기
            });
            stompClient.subscribe('/topic/order/cancel', function(response) { // 주문 취소 구독
                showMessage("Order Canceled: " + JSON.parse(response.body).id);
                fetchCurrentOrders(); // 현재 주문 내역을 다시 가져오기
            });
            stompClient.subscribe('/topic/current-orders', function(response) { // 현재 주문 내역 구독
                updateCurrentOrders(JSON.parse(response.body));
            });
        }, function(error) {
            console.log('Error: ' + error);
        });
    }

    function completeOrder() {
        var orderId = document.getElementById("completeOrderId").value; // 현재 주문 ID 가져오기
        if (!orderId) {
            alert("주문 ID를 입력하세요.");
            return;
        }
        stompClient.send("/app/order/complete/" + orderId, {}, {}); // 주문 완료 요청 전송
    }

    function cancelOrder() {
        var orderId = document.getElementById("cancelOrderId").value; // 현재 주문 ID 가져오기
        if (!orderId) {
            alert("주문 ID를 입력하세요.");
            return;
        }
        stompClient.send("/app/order/cancel/" + orderId, {}, {}); // 주문 취소 요청 전송
    }

    function showMessage(message) {
        var messageArea = document.getElementById('messages');
        messageArea.innerHTML += message + '<br/>';
    }

    function updateCurrentOrders(orders) {
        var pendingOrdersArea = document.getElementById('pendingOrders');
        var completedOrdersArea = document.getElementById('completedOrders');
        var canceledOrdersArea = document.getElementById('canceledOrders');

        pendingOrdersArea.innerHTML = ''; // 기존 내용 초기화
        completedOrdersArea.innerHTML = ''; // 기존 내용 초기화
        canceledOrdersArea.innerHTML = ''; // 기존 내용 초기화

        orders.forEach(order => {
            if (order.orderState === "잠시만 기다려주세요.") { // 대기 중인 주문
                pendingOrdersArea.innerHTML += `Order ID: ${order.id}, User ID: ${order.userId}, Vending Machine Name: ${order.vendingMachineName}, Status: ${order.orderState}<br/>`;
            } else if (order.orderState === "완료") { // 완료된 주문
                completedOrdersArea.innerHTML += `Order ID: ${order.id}, User ID: ${order.userId}, Vending Machine Name: ${order.vendingMachineName}, Status: ${order.orderState}<br/>`;
            } else if (order.orderState === "취소") { // 취소된 주문
                canceledOrdersArea.innerHTML += `Order ID: ${order.id}, User ID: ${order.userId}, Vending Machine Name: ${order.vendingMachineName}, Status: ${order.orderState}<br/>`;
            }
        });
    }

    function fetchCurrentOrders() {
        stompClient.send("/app/current-orders", {}, {}); // 현재 주문 요청 전송 (서버에서 처리)
    }
</script>
</body>
</html>