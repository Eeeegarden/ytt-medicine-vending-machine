<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>자판기 주문 관리 시스템</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        .order-section {
            margin-bottom: 20px;
        }
        .order-item {
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<h1>자판기 주문 관리 시스템</h1>

<label for="vendingMachineId">자판기 ID:</label>
<input type="text" id="vendingMachineId" placeholder="자판기 ID 입력" />
<button onclick="connect()">연결</button>

<h2>주문 보관 완료</h2>
<label for="storeOrderId">주문 ID:</label>
<input type="text" id="storeOrderId" placeholder="보관 완료할 주문 ID 입력" />
<button onclick="storeOrder()">주문 보관 완료</button>

<h2>주문 완료(사용자)</h2>
<label for="completeOrderId">주문 ID:</label>
<input type="text" id="completeOrderId" placeholder="완료할 주문 ID 입력" />
<button onclick="completeOrder()">주문 완료</button>

<h2>주문 취소(사용자)</h2>
<label for="cancelOrderId">주문 ID:</label>
<input type="text" id="cancelOrderId" placeholder="취소할 주문 ID 입력" />
<button onclick="cancelOrder()">주문 취소</button>

<h2>현재 주문 목록</h2>
<button onclick="fetchCurrentOrders()">주문 목록 새로고침</button>

<div class="order-section">
    <h3>대기중인 주문</h3>
    <div id="pendingOrders"></div>
</div>

<div class="order-section">
    <h3>보관중인 주문</h3>
    <div id="storedOrders"></div>
</div>

<div class="order-section">
    <h3>완료된 주문</h3>
    <div id="completedOrders"></div>
</div>

<div class="order-section">
    <h3>취소된 주문</h3>
    <div id="canceledOrders"></div>
</div>

<div id="messages"></div>

<script>
    var stompClient = null;
    var fetchInterval = null;
    var vendingMachineId = null;

    function connect() {
        vendingMachineId = document.getElementById("vendingMachineId").value;
        if (!vendingMachineId) {
            alert("자판기 ID를 입력하세요.");
            return;
        }

        var socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function(frame) {
            console.log('연결됨: ' + frame);
            stompClient.subscribe('/topic/orders/vending-machine/' + vendingMachineId, function(response) {
                console.log('Received message:', response.body); // 디버깅용
                const data = JSON.parse(response.body);
                if (Array.isArray(data)) {
                    // 리스트로 받은 경우 각각의 주문을 처리
                    data.forEach(order => updateOrder(order));
                } else {
                    // 단일 주문인 경우
                    updateOrder(data);
                }
            });
            fetchCurrentOrders();
        }, function(error) {
            console.log('오류: ' + error);
        });
    }

    function fetchCurrentOrders() {
        if (stompClient && stompClient.connected) {
            stompClient.send("/app/current-orders/vending-machine/" + vendingMachineId, {}, "");
        }
    }

    function storeOrder() {
        var orderId = document.getElementById("storeOrderId").value;
        if (!orderId) {
            alert("주문 ID를 입력하세요.");
            return;
        }
        stompClient.send("/app/order/store/" + orderId, {}, "");
    }

    function completeOrder() {
        var orderId = document.getElementById("completeOrderId").value;
        if (!orderId) {
            alert("주문 ID를 입력하세요.");
            return;
        }
        stompClient.send("/app/order/complete/" + orderId, {}, "");
    }

    function cancelOrder() {
        var orderId = document.getElementById("cancelOrderId").value;
        if (!orderId) {
            alert("주문 ID를 입력하세요.");
            return;
        }
        stompClient.send("/app/order/cancel/" + orderId, {}, "");
    }

    function showMessage(message) {
        var messageArea = document.getElementById('messages');
        messageArea.innerHTML += message + '<br/>';
    }

    function updateOrder(order) {
        var orderItems = order.orderItems.map(item =>
            `${item.productCode}: ${item.quantity}개`
        ).join(', ');

        var orderInfo = `
        <div class="order-item" id="order-${order.id}">
            주문 ID: ${order.id}<br>
            주문 시간: ${order.orderAt}<br>
            주문 항목: ${orderItems}<br>
            상태: ${order.orderState}<br>
        </div>
        `;

        var targetArea;
        switch(order.orderState) {
            case "PENDING":
                targetArea = document.getElementById('pendingOrders');
                break;
            case "COMPLETED":
                targetArea = document.getElementById('completedOrders');
                break;
            case "CANCELED":
                targetArea = document.getElementById('canceledOrders');
                break;
            case "STORED":
                targetArea = document.getElementById('storedOrders');
                break;
        }

        var existingOrder = document.getElementById(`order-${order.id}`);
        if (existingOrder) {
            existingOrder.remove();
        }
        targetArea.innerHTML += orderInfo;
    }

</script>
</body>
</html>